name: Merged PR

on:
  pull_request:
    types: [closed]

jobs:
  cleanup-labels:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    permissions:
      issues: write
      pull-requests: write
    
    steps:
      - name: Remove review required label
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            
            try {
              // Get current labels on the PR
              const { data: labels } = await github.rest.issues.listLabelsOnIssue({
                owner,
                repo,
                issue_number
              });
              
              // Check if 'review required' label exists
              const hasReviewRequiredLabel = labels.some(label => label.name === 'review required');
              
              if (hasReviewRequiredLabel) {
                // Remove the 'review required' label
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number,
                  name: 'review required'
                });
                
                console.log('✅ Removed "review required" label from merged PR #' + issue_number);
              } else {
                console.log('ℹ️ No "review required" label found on PR #' + issue_number);
              }
              
              // Also remove validation-related labels that are no longer relevant
              const labelsToRemove = [
                'missing metadata.json',
                'invalid metadata.json', 
                'missing logo.png'
              ];
              
              for (const labelName of labelsToRemove) {
                const hasLabel = labels.some(label => label.name === labelName);
                if (hasLabel) {
                  await github.rest.issues.removeLabel({
                    owner,
                    repo,
                    issue_number,
                    name: labelName
                  });
                  console.log('✅ Removed "' + labelName + '" label from merged PR #' + issue_number);
                }
              }
              
            } catch (error) {
              if (error.status === 404) {
                console.log('ℹ️ Label not found (may have been already removed)');
              } else {
                console.error('❌ Error removing labels:', error);
                throw error;
              }
            }